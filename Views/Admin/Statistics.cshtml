@{
    ViewData["Title"] = "Thống kê";
    var stats = (dynamic)Model;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-bar"></i> Thống kê hệ thống</h2>
    </div>

    <!-- Statistics Overview -->
    <div class="row mb-4">
        <!-- Users by Role -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Người dùng theo vai trò</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Vai trò</th>
                                    <th class="text-end">Số lượng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in stats.UsersByRole)
                                {
                                    <tr>
                                        <td>
                                            @switch (item.Role)
                                            {
                                                case "Admin":
                                                    <span class="badge bg-danger">Admin</span>
                                                    break;
                                                case "Employer":
                                                    <span class="badge bg-primary">Nhà tuyển dụng</span>
                                                    break;
                                                case "Applicant":
                                                    <span class="badge bg-success">Ứng viên</span>
                                                    break;
                                                default:
                                                    <span>@item.Role</span>
                                                    break;
                                            }
                                        </td>
                                        <td class="text-end"><strong>@item.Count</strong></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jobs by Status -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-briefcase"></i> Việc làm theo trạng thái</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Trạng thái</th>
                                    <th class="text-end">Số lượng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in stats.JobsByStatus)
                                {
                                    <tr>
                                        <td>
                                            @switch (item.Status)
                                            {
                                                case "Approved":
                                                    <span class="badge bg-success">Đã duyệt</span>
                                                    break;
                                                case "Pending":
                                                    <span class="badge bg-warning">Chờ duyệt</span>
                                                    break;
                                                case "Rejected":
                                                    <span class="badge bg-danger">Từ chối</span>
                                                    break;
                                                case "Closed":
                                                    <span class="badge bg-secondary">Đã đóng</span>
                                                    break;
                                                default:
                                                    <span>@item.Status</span>
                                                    break;
                                            }
                                        </td>
                                        <td class="text-end"><strong>@item.Count</strong></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jobs by Category -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-th-large"></i> Việc làm theo danh mục</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Danh mục</th>
                                    <th class="text-end">Số lượng</th>
                                    <th class="text-end">Tỷ lệ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var jobsByCategoryList = ((IEnumerable<dynamic>)stats.JobsByCategory).ToList();
                                    var totalJobs = 0;
                                    foreach (var cat in jobsByCategoryList)
                                    {
                                        totalJobs += (int)cat.Count;
                                    }
                                }
                                @foreach (var item in jobsByCategoryList)
                                {
                                    var percentage = totalJobs > 0 ? (item.Count * 100.0 / totalJobs) : 0;
                                    <tr>
                                        <td>
                                            <span class="badge bg-info">@item.Category</span>
                                        </td>
                                        <td class="text-end"><strong>@item.Count</strong></td>
                                        <td class="text-end">
                                            <div class="d-flex align-items-center justify-content-end">
                                                <div class="progress flex-grow-1 me-2" style="height: 20px; max-width: 200px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: @percentage%"
                                                         aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                                        @percentage.ToString("F1")%
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <!-- Recent Users -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-user-plus"></i> Người dùng mới nhất</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        @foreach (var user in stats.RecentUsers)
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">@user.FullName</h6>
                                        <small class="text-muted">@user.Email</small>
                                    </div>
                                    <div class="text-end">
                                        @switch (user.Role)
                                        {
                                            case "Admin":
                                                <span class="badge bg-danger">Admin</span>
                                                break;
                                            case "Employer":
                                                <span class="badge bg-primary">NTD</span>
                                                break;
                                            case "Applicant":
                                                <span class="badge bg-success">UV</span>
                                                break;
                                        }
                                        <div><small class="text-muted">@user.CreatedAt.ToShortDateString()</small></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Jobs -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-briefcase"></i> Việc làm mới nhất</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        @foreach (var job in stats.RecentJobs)
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">
                                            <a asp-controller="Jobs" asp-action="Details" asp-route-id="@job.Id">
                                                @job.Title
                                            </a>
                                        </h6>
                                        <small class="text-muted">@job.CompanyName</small>
                                    </div>
                                    <div class="text-end">
                                        @switch (job.Status)
                                        {
                                            case "Approved":
                                                <span class="badge bg-success">Đã duyệt</span>
                                                break;
                                            case "Pending":
                                                <span class="badge bg-warning">Chờ duyệt</span>
                                                break;
                                            case "Rejected":
                                                <span class="badge bg-danger">Từ chối</span>
                                                break;
                                            case "Closed":
                                                <span class="badge bg-secondary">Đóng</span>
                                                break;
                                        }
                                        <div><small class="text-muted">@job.CreatedAt.ToShortDateString()</small></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
